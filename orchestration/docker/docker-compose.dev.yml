# ═══════════════════════════════════════════════════════════════════════════════
#   Multi-Agent Orchestration — docker-compose.dev.yml
#   Development Stack: Postgres, MinIO (S3), Kafka — January 2026
# ═══════════════════════════════════════════════════════════════════════════════

version: '3.9'

services:
  # ═══════════════════════════════════════════════════════════════════════════════
  # PostgreSQL Database
  # ═══════════════════════════════════════════════════════════════════════════════
  postgres:
    image: postgres:16-alpine
    container_name: orchestrator-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: orchestrator
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-orchestrator_dev_2026}
      POSTGRES_DB: orchestrator
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts/postgres:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orchestrator -d orchestrator"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - orchestrator-net

  # ═══════════════════════════════════════════════════════════════════════════════
  # MinIO (S3-Compatible Object Storage)
  # ═══════════════════════════════════════════════════════════════════════════════
  minio:
    image: minio/minio:latest
    container_name: orchestrator-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin2026}
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Console
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - orchestrator-net

  # MinIO bucket initialization
  minio-init:
    image: minio/mc:latest
    container_name: orchestrator-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin2026;
      mc mb myminio/artifacts-opus --ignore-existing;
      mc mb myminio/proposals --ignore-existing;
      mc mb myminio/reports --ignore-existing;
      mc mb myminio/audit-logs --ignore-existing;
      mc anonymous set download myminio/reports;
      exit 0;
      "
    networks:
      - orchestrator-net

  # ═══════════════════════════════════════════════════════════════════════════════
  # Kafka (Event Bus)
  # ═══════════════════════════════════════════════════════════════════════════════
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: orchestrator-zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_log:/var/lib/zookeeper/log
    networks:
      - orchestrator-net

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: orchestrator-kafka
    restart: unless-stopped
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    ports:
      - "29092:29092"
      - "9092:9092"
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - orchestrator-net

  # Kafka topic initialization
  kafka-init:
    image: confluentinc/cp-kafka:7.5.0
    container_name: orchestrator-kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic proposals --partitions 3 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic votes --partitions 3 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic events --partitions 3 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic metrics --partitions 1 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic audit --partitions 1 --replication-factor 1;
      echo 'Kafka topics created successfully';
      exit 0;
      "
    networks:
      - orchestrator-net

  # ═══════════════════════════════════════════════════════════════════════════════
  # Redis (Caching & Sessions)
  # ═══════════════════════════════════════════════════════════════════════════════
  redis:
    image: redis:7-alpine
    container_name: orchestrator-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - orchestrator-net

  # ═══════════════════════════════════════════════════════════════════════════════
  # Orchestrator Service
  # ═══════════════════════════════════════════════════════════════════════════════
  orchestrator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.orchestrator
    container_name: orchestrator-mcp
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      NODE_ENV: development
      PORT: 8443
      DATABASE_URL: postgres://orchestrator:orchestrator_dev_2026@postgres:5432/orchestrator
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://redis:6379
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin2026
      S3_BUCKET: artifacts-opus
    ports:
      - "8443:8443"
    volumes:
      - ../config:/app/config:ro
      - orchestrator_logs:/app/logs
    networks:
      - orchestrator-net

  # ═══════════════════════════════════════════════════════════════════════════════
  # Agent Container
  # ═══════════════════════════════════════════════════════════════════════════════
  agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
    container_name: orchestrator-agent
    restart: unless-stopped
    depends_on:
      - orchestrator
    environment:
      MCP_URL: http://orchestrator:8443
      ARTIFACT_S3: s3://artifacts-opus
      PRIMARY_MODEL: claude-4.5-opus
      CONFIDENCE_THRESHOLD: "0.75"
    volumes:
      - ${WORKSPACE_PATH:-../..}:/workspace:ro
      - agent_logs:/app/logs
    networks:
      - orchestrator-net

  # ═══════════════════════════════════════════════════════════════════════════════
  # Kafka UI (Development Only)
  # ═══════════════════════════════════════════════════════════════════════════════
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: orchestrator-kafka-ui
    restart: unless-stopped
    depends_on:
      - kafka
    environment:
      KAFKA_CLUSTERS_0_NAME: orchestrator-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    ports:
      - "8080:8080"
    networks:
      - orchestrator-net

# ═══════════════════════════════════════════════════════════════════════════════
# Networks
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  orchestrator-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ═══════════════════════════════════════════════════════════════════════════════
# Volumes  
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  postgres_data:
  minio_data:
  zookeeper_data:
  zookeeper_log:
  kafka_data:
  redis_data:
  orchestrator_logs:
  agent_logs:
